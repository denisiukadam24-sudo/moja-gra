<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Gra 3D Multiplayer Optymalizacja</title>
<style>
body { margin:0; overflow:hidden; }
#menu {
    position:absolute;top:0;left:0;width:100%;height:100%;
    background:#000a;color:white;display:flex;flex-direction:column;
    align-items:center;justify-content:center;z-index:10;
}
#menu button { margin:10px;padding:10px 20px;font-size:20px; cursor:pointer; }
</style>
</head>
<body>
<div id="menu">
  <h1>Gra 3D Multiplayer</h1>
  <button onclick="startNewGame()">Nowa Gra</button>
  <button onclick="loadGame()">Wczytaj Grę</button>
  <button onclick="exitGame()">Wyjście</button>
  <button onclick="startMultiplayer()">Multiplayer</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script>
let scene, camera, renderer;
let car, player, terrain;
let leftLeg, rightLeg, leftArm, rightArm;
let keys = {};
let playerInCar = false, carSpeed = 0, walkTime = 0;
const MAP_SIZE = 1600;
let trees, houses, cars = [];
let playerYVel = 0;

// ---------------- MULTIPLAYER ----------------
let socket=null, otherPlayers={};
function startMultiplayer(){
    if(socket) return;
    socket = new WebSocket("ws://localhost:8080"); // zmień na swój adres serwera
    socket.onmessage = msg=>{
        const data = JSON.parse(msg.data);
        for(let id in data){
            if(id===socket.id) continue;
            if(!otherPlayers[id]){
                const group = new THREE.Group();
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(0.6,1,0.3), new THREE.MeshPhongMaterial({color:0xff0000}));
                mesh.position.set(data[id].x,getTerrainHeight(data[id].x,data[id].z),data[id].z); group.add(mesh);
                const carMesh = car.clone();
                carMesh.position.set(data[id].carX,getTerrainHeight(data[id].carX,data[id].carZ)+0.5,data[id].carZ);
                carMesh.rotation.y = data[id].carRot; group.add(carMesh);
                scene.add(group); otherPlayers[id]=group;
            } else {
                const group = otherPlayers[id];
                group.children[0].position.set(data[id].x,getTerrainHeight(data[id].x,data[id].z),data[id].z);
                group.children[1].position.set(data[id].carX,getTerrainHeight(data[id].carX,data[id].carZ)+0.5,data[id].carZ);
                group.children[1].rotation.y = data[id].carRot;
            }
        }
        for(let id in otherPlayers){ if(!data[id]){ scene.remove(otherPlayers[id]); delete otherPlayers[id]; } }
    };
    setInterval(()=>{
        if(socket && socket.readyState===WebSocket.OPEN){
            socket.send(JSON.stringify({
                x:player.position.x,
                z:player.position.z,
                carX:car.position.x,
                carZ:car.position.z,
                carRot:car.rotation.y
            }));
        }
    },50);
}

// --------------------- SCENA ---------------------
function initScene(){
    if(renderer) return;
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);
    camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 5000);
    renderer = new THREE.WebGLRenderer({antialias:false});
    renderer.setPixelRatio(window.devicePixelRatio/2);
    renderer.setSize(innerWidth,innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff,0.6));
    const light = new THREE.DirectionalLight(0xffffff,1); light.position.set(200,400,200); scene.add(light);

    createTerrain();
    createStreets();
    createInstancedTrees(50);
    createInstancedHouses(50);
    createCar();
    createPlayer();
    spawnCars(10);

    document.addEventListener("keydown", e=>{ keys[e.code]=true; if(e.code==="KeyL") saveGame(); if(e.code==="Escape") document.getElementById('menu').style.display='flex'; });
    document.addEventListener("keyup", e=>keys[e.code]=false);

    animate();
}

// --------------------- TEREN ---------------------
function createTerrain(){
    const geometry = new THREE.PlaneGeometry(MAP_SIZE, MAP_SIZE, 128, 128); // mniejsza siatka
    for(let i=0;i<geometry.attributes.position.count;i++){
        const y=Math.random()*20-Math.random()*10;
        geometry.attributes.position.setY(i,y);
    }
    geometry.computeVertexNormals();
    terrain = new THREE.Mesh(geometry,new THREE.MeshPhongMaterial({color:0x228B22,flatShading:true}));
    terrain.rotation.x=-Math.PI/2; scene.add(terrain);
}
function getTerrainHeight(x,z){
    const ray=new THREE.Raycaster(new THREE.Vector3(x,50,z),new THREE.Vector3(0,-1,0));
    const intersect=ray.intersectObject(terrain);
    if(intersect.length>0) return intersect[0].point.y;
    return 0;
}

// --------------------- ULICA ---------------------
function createStreets(){
    function createCurvyStreet(points){
        const curve = new THREE.CatmullRomCurve3(points.map(p=>new THREE.Vector3(p.x,0.01,p.z)));
        const geometry = new THREE.TubeGeometry(curve,50,20,4,false);
        const material = new THREE.MeshPhongMaterial({color:0x333333});
        const street = new THREE.Mesh(geometry,material); scene.add(street);
    }
    createCurvyStreet([{x:-300,z:-300},{x:-100,z:-50},{x:0,z:0},{x:100,z:50},{x:300,z:300}]);
    createCurvyStreet([{x:-300,z:300},{x:-150,z:100},{x:0,z:0},{x:150,z:-100},{x:300,z:-300}]);
}
function isStreet(x,z){ return (Math.abs(x)<40 || Math.abs(z)<40); }

// --------------------- DRZEWA i DOMY ---------------------
function createInstancedTrees(count){
    const geometry = new THREE.CylinderGeometry(0.2,0.3,2,6);
    const leaves = new THREE.SphereGeometry(1,6,6);
    const materialTrunk = new THREE.MeshPhongMaterial({color:0x8B4513});
    const materialLeaves = new THREE.MeshPhongMaterial({color:0x228B22});
    trees = new THREE.InstancedMesh(geometry, materialTrunk, count);
    const leavesMesh = new THREE.InstancedMesh(leaves, materialLeaves, count);
    const dummy = new THREE.Object3D();
    for(let i=0;i<count;i++){
        let x,z; do{ x=(Math.random()-0.5)*(MAP_SIZE-50); z=(Math.random()-0.5)*(MAP_SIZE-50);} while(isStreet(x,z));
        dummy.position.set(x,1,z); dummy.updateMatrix(); trees.setMatrixAt(i,dummy.matrix);
        dummy.position.set(x,2.5,z); dummy.updateMatrix(); leavesMesh.setMatrixAt(i,dummy.matrix);
    }
    scene.add(trees); scene.add(leavesMesh);
}
function createInstancedHouses(count){
    const geometry = new THREE.BoxGeometry(10,6,10);
    const material = new THREE.MeshPhongMaterial({color:0xaaaaaa});
    houses = new THREE.InstancedMesh(geometry, material, count);
    const dummy = new THREE.Object3D();
    for(let i=0;i<count;i++){
        let x,z; do{x=(Math.random()-0.5)*(MAP_SIZE-50); z=(Math.random()-0.5)*(MAP_SIZE-50);} while(isStreet(x,z));
        dummy.position.set(x,3,z); dummy.updateMatrix(); houses.setMatrixAt(i,dummy.matrix);
    }
    scene.add(houses);
}

// --------------------- POSTAĆ ---------------------
function createPlayer(){
    player = new THREE.Group();
    const material = new THREE.MeshPhongMaterial({color:0xdddddd});
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.6,1,0.3), material); body.position.y=1.5; player.add(body);
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.25,8,8), new THREE.MeshPhongMaterial({color:0xffccaa})); head.position.y=2.2; player.add(head);
    leftArm=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.7,0.15), material); leftArm.position.set(-0.45,1.5,0); player.add(leftArm);
    rightArm=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.7,0.15), material); rightArm.position.set(0.45,1.5,0); player.add(rightArm);
    leftLeg=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.8,0.2), material); leftLeg.position.set(-0.2,0.6,0); player.add(leftLeg);
    rightLeg=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.8,0.2), material); rightLeg.position.set(0.2,0.6,0); player.add(rightLeg);
    player.position.set(3,getTerrainHeight(3,0),0); scene.add(player);
}

// --------------------- SAMOCHÓD ---------------------
function createCar(){
    car=new THREE.Group();
    const body=new THREE.Mesh(new THREE.BoxGeometry(2,0.5,4),new THREE.MeshPhongMaterial({color:0x111111})); body.position.y=0.5; car.add(body);
    const roof=new THREE.Mesh(new THREE.BoxGeometry(1.6,0.4,2),new THREE.MeshPhongMaterial({color:0x222222})); roof.position.set(0,0.9,-0.3); car.add(roof);
    function wheel(x,z){ const w=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.3,8),new THREE.MeshPhongMaterial({color:0x333333})); w.rotation.z=Math.PI/2; w.position.set(x,0.3,z); car.add(w);}
    wheel(1,1.5); wheel(-1,1.5); wheel(1,-1.5); wheel(-1,-1.5);
    car.position.set(0,getTerrainHeight(0,0),0); scene.add(car);
}

function spawnCars(number){
    for(let i=0;i<number;i++){
        const c=car.clone();
        let x,z; do{x=(Math.random()-0.5)*(MAP_SIZE-50); z=(Math.random()-0.5)*(MAP_SIZE-50);}while(!isStreet(x,z));
        c.position.set(x,getTerrainHeight(x,z)+0.5,z);
        const path=[{x:-300,z:0},{x:0,z:300},{x:300,z:0},{x:0,z:-300}];
        cars.push({mesh:c,speed:0.5,path:path,pathIndex:0}); scene.add(c);
    }
}

// --------------------- MENU ---------------------
function startNewGame(){ document.getElementById('menu').style.display='none'; initScene(); player.position.set(3,getTerrainHeight(3,0),0); car.position.set(0,getTerrainHeight(0,0),0); playerInCar=false;}
function loadGame(){ document.getElementById('menu').style.display='none'; initScene(); const save=localStorage.getItem("gameSave"); if(save){const d=JSON.parse(save); player.position.set(d.playerX,getTerrainHeight(d.playerX,d.playerZ),d.playerZ); car.position.set(d.carX,getTerrainHeight(d.carX,d.carZ)+0.5,d.carZ); car.rotation.y=d.carRot; playerInCar=false;} else startNewGame();}
function exitGame(){ window.location.href="about:blank";}
function saveGame(){const data={playerX:player.position.x,playerZ:player.position.z,carX:car.position.x,carZ:car.position.z,carRot:car.rotation.y}; localStorage.setItem("gameSave",JSON.stringify(data)); console.log("Gra zapisana!");}

// --------------------- ANIMACJA ---------------------
function animate(){
    requestAnimationFrame(animate);
    // --- Sterowanie gracza i samochodu ---
    if(keys["KeyE"]) toggleCar();
    let moving=false;
    if(playerInCar){
        if(keys["KeyW"]) carSpeed+=0.02; if(keys["KeyS"]) carSpeed-=0.02; carSpeed*=0.98;
        car.translateZ(carSpeed);
        if(keys["KeyA"]) car.rotation.y+=0.03; if(keys["KeyD"]) car.rotation.y-=0.03;
        camera.position.x=car.position.x-Math.sin(car.rotation.y)*10;
        camera.position.z=car.position.z-Math.cos(car.rotation.y)*10;
        camera.position.y=car.position.y+5; camera.lookAt(car.position);
    } else {
        if(keys["KeyW"]){ player.position.z-=0.2; moving=true; }
        if(keys["KeyS"]){ player.position.z+=0.2; moving=true; }
        if(keys["KeyA"]){ player.position.x-=0.2; moving=true; }
        if(keys["KeyD"]){ player.position.x+=0.2; moving=true; }
        player.position.y = getTerrainHeight(player.position.x, player.position.z);
        if(moving){ walkTime+=0.15; leftLeg.rotation.x=Math.sin(walkTime)*0.8; rightLeg.rotation.x=-Math.sin(walkTime)*0.8; leftArm.rotation.x=-Math.sin(walkTime)*0.8; rightArm.rotation.x=Math.sin(walkTime)*0.8; }
        else{ leftLeg.rotation.x*=0.8; rightLeg.rotation.x*=0.8; leftArm.rotation.x*=0.8; rightArm.rotation.x*=0.8; }
        camera.position.x = player.position.x - Math.sin(player.rotation.y)*5;
        camera.position.y = player.position.y + 3;
        camera.position.z = player.position.z - Math.cos(player.rotation.y)*5;
        camera.lookAt(player.position.x, player.position.y + 1.5, player.position.z);
    }

    // --- AI samochody ---
    cars.forEach(c=>{
        const p1=c.path[c.pathIndex]; const p2=c.path[(c.pathIndex+1)%c.path.length];
        const dir=new THREE.Vector3(p2.x-p1.x,0,p2.z-p1.z).normalize();
        c.mesh.position.add(dir.clone().multiplyScalar(c.speed));
        c.mesh.position.y=getTerrainHeight(c.mesh.position.x,c.mesh.position.z)+0.5;
        c.mesh.lookAt(p2.x,c.mesh.position.y,p2.z);
        if(c.mesh.position.distanceTo(new THREE.Vector3(p2.x,c.mesh.position.y,p2.z))<1) c.pathIndex=(c.pathIndex+1)%c.path.length;
    });

    renderer.render(scene,camera);
}

// --------------------- WSIADANIE ---------------------
function toggleCar(){ if(playerInCar){playerInCar=false; player.visible=true; player.position.set(car.position.x+2,getTerrainHeight(car.position.x+2,car.position.z),car.position.z); return;} const dx=player.position.x-car.position.x; const dz=player.position.z-car.position.z; if(Math.sqrt(dx*dx+dz*dz)<3){playerInCar=true; player.visible=false; carSpeed=0;}}
</script>
</body>
</html>
